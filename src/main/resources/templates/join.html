<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="bg-light">

<header class="bg-primary text-white text-center py-3">
    <h1>쇼핑몰 회원가입</h1>
</header>

<main class="container my-5">
    <div class="card shadow-sm">
        <div class="card-body">
            <form th:action="@{/join}" th:object="${memberJoinDto}" method="post" id="joinForm">

                <!-- 약관 동의 영역 -->
                <h4 class="mb-3">1. 서비스 이용 약관 동의</h4>

                <!-- 전체 동의 -->
                <div class="form-check mb-3">
                    <input type="checkbox" id="agreeAll" class="form-check-input">
                    <label for="agreeAll" class="form-check-label fw-bold">
                        전체 약관에 동의합니다 (선택 포함)
                    </label>
                </div>

                <hr>

                <!-- 필수 약관 -->
                <div class="form-check d-flex align-items-center justify-content-between mb-2">
                    <div>
                        <input type="checkbox" id="agreeService" name="agreeService" required class="form-check-input agree-check">
                        <label for="agreeService" class="form-check-label">[필수] 이용 약관 동의</label>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showTerms('service')">전문 보기</button>
                </div>

                <div class="form-check d-flex align-items-center justify-content-between mb-2">
                    <div>
                        <input type="checkbox" id="agreePrivacy" name="agreePrivacy" required class="form-check-input agree-check">
                        <label for="agreePrivacy" class="form-check-label">[필수] 개인정보 수집 및 이용 동의</label>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showTerms('privacy')">전문 보기</button>
                </div>

                <!-- 선택 약관 -->
                <div class="form-check d-flex align-items-center justify-content-between mb-2">
                    <div>
                        <input type="checkbox" id="agreeMarketing" name="agreeMarketing" class="form-check-input agree-check">
                        <label for="agreeMarketing" class="form-check-label">[선택] 마케팅 정보 수신 동의</label>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showTerms('marketing')">전문 보기</button>
                </div>

                <div class="form-check mb-4">
                    <input type="checkbox" id="agreeSms" name="agreeSms" class="form-check-input agree-check">
                    <label for="agreeSms" class="form-check-label">[선택] SMS 수신 동의</label>
                </div>

                <hr>

                <!-- 회원 정보 입력 -->
                <h4 class="mb-3">2. 회원 정보 입력</h4>

                <div class="mb-3">
                    <label for="username" class="form-label">아이디 (유저명) *</label>
                    <div class="input-group">
                        <input type="text" id="username" class="form-control" th:field="*{username}" required>
                        <button type="button" class="btn btn-outline-primary" onclick="checkDuplicate()">중복 확인</button>
                    </div>
                    <!-- 결과 메시지 -->
                    <small id="dup-message" class="mt-1 d-block"></small>
                </div>


                <div class="mb-3">
                    <label for="password" class="form-label">비밀번호 *</label>
                    <input type="password" id="password" class="form-control"
                           th:field="*{password}" required>

                    <!-- 실시간 결과 표시 -->
                    <small id="password-validation" class="d-block mt-1"></small>
                </div>

                <div class="mb-3">
                    <label for="passwordConfirm" class="form-label">비밀번호 확인 *</label>
                    <input type="password" id="passwordConfirm" class="form-control" required>

                    <!-- 비밀번호 확인 메시지 -->
                    <small id="password-confirm-validation" class="d-block mt-1"></small>
                </div>


                <div class="mb-3">
                    <label for="email" class="form-label">이메일 *</label>
                    <input type="email" id="email" class="form-control" th:field="*{email}" required>
                </div>

                <div class="mb-3">
                    <label for="phone" class="form-label">휴대폰 번호</label>
                    <input type="tel" id="phone" class="form-control" th:field="*{phone}">
                </div>

                <div id="agreement-message" class="text-danger mb-3">
                    필수 약관에 동의해야 가입할 수 있습니다.
                </div>

                <button type="submit" class="btn btn-primary w-100 submit-button" disabled>
                    회원가입
                </button>

            </form>
        </div>
    </div>
</main>

<footer class="text-center py-3 text-muted">
    &copy; 2025 Shopping Mall
</footer>
<script>
    // ------------------------------------------------------
    // 약관 체크 요소
    // ------------------------------------------------------
    const agreeAll = document.getElementById('agreeAll');
    const allCheckboxes = document.querySelectorAll('.agree-check');
    const requiredCheckboxes = document.querySelectorAll('.agree-check[required]');
    const submitButton = document.querySelector('.submit-button');
    const agreementMessage = document.getElementById('agreement-message');

    // ------------------------------------------------------
    // 아이디 중복 확인 상태 플래그
    // ------------------------------------------------------
    let usernameChecked = false;

    // ------------------------------------------------------
    // 비밀번호 요소 + 정규식
    // ------------------------------------------------------
    const pwdInput = document.getElementById("password");
    const pwdMsg = document.getElementById("password-validation");
    const pwd = document.getElementById("password");
    const pwdConfirm = document.getElementById("passwordConfirm");
    const pwdConfirmMsg = document.getElementById("password-confirm-validation");

    // 영어 + 숫자 + 특수문자 포함, 8자리 이상
    const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[^\w\s]).{8,}$/;


    // ------------------------------------------------------
    // 회원가입 버튼 상태 업데이트 (모든 조건을 종합 검사)
    // ------------------------------------------------------
    function updateSubmitButtonState() {

        // 1) 필수 약관 체크
        const requiredAgreed = Array.from(requiredCheckboxes).every(c => c.checked);

        // 2) 비밀번호 규칙 검사
        const passwordValid = passwordRegex.test(pwdInput.value);

        // 3) 비밀번호 일치 검사
        const passwordMatch = (pwd.value === pwdConfirm.value);

        // 4) 아이디 중복 확인 여부
        // console.log("아이디 중복 확인 여부:", usernameChecked);

        // 최종 조건
        if (requiredAgreed && passwordValid && passwordMatch && usernameChecked) {
            submitButton.disabled = false;
            agreementMessage.style.display = 'none';
        } else {
            submitButton.disabled = true;

            if (!requiredAgreed) {
                agreementMessage.style.display = 'block';
            }
        }
    }


    // ------------------------------------------------------
    // 약관 체크 이벤트
    // ------------------------------------------------------
    agreeAll.addEventListener('change', function () {
        allCheckboxes.forEach(cb => cb.checked = agreeAll.checked);
        updateSubmitButtonState();
    });

    allCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            const allChecked = Array.from(allCheckboxes).every(c => c.checked);
            agreeAll.checked = allChecked;
            updateSubmitButtonState();
        });
    });


    // ------------------------------------------------------
    // 비밀번호 규칙 실시간 검사
    // ------------------------------------------------------
    pwdInput.addEventListener("input", function () {
        const pwdValue = pwdInput.value;

        if (pwdValue.length === 0) {
            pwdMsg.textContent = "";
        } else if (passwordRegex.test(pwdValue)) {
            pwdMsg.textContent = "✔ 사용 가능한 비밀번호입니다.";
            pwdMsg.className = "text-success d-block mt-1";
        } else {
            pwdMsg.textContent = "❌ 영어, 숫자, 특수문자를 포함한 8자리 이상이어야 합니다.";
            pwdMsg.className = "text-danger d-block mt-1";
        }

        updateSubmitButtonState();
    });


    // ------------------------------------------------------
    // 비밀번호 확인 실시간 검사
    // ------------------------------------------------------
    function validatePasswordMatch() {
        if (pwdConfirm.value.length === 0) {
            pwdConfirmMsg.textContent = "";
        } else if (pwd.value === pwdConfirm.value) {
            pwdConfirmMsg.textContent = "✔ 비밀번호가 일치합니다.";
            pwdConfirmMsg.className = "text-success d-block mt-1";
        } else {
            pwdConfirmMsg.textContent = "❌ 비밀번호가 일치하지 않습니다.";
            pwdConfirmMsg.className = "text-danger d-block mt-1";
        }

        updateSubmitButtonState();
    }

    pwd.addEventListener("input", validatePasswordMatch);
    pwdConfirm.addEventListener("input", validatePasswordMatch);


    // ------------------------------------------------------
    // 아이디 중복 확인 (버튼 클릭 시 호출)
    // ------------------------------------------------------
    async function checkDuplicate() {
        const username = document.getElementById("username").value.trim();
        const messageEl = document.getElementById("dup-message");

        usernameChecked = false; // 기본값 (다시 입력하거나 실패하면 false)

        if (username === "") {
            messageEl.textContent = "아이디를 입력하세요.";
            messageEl.className = "text-danger";
            updateSubmitButtonState();
            return;
        }

        try {
            const res = await fetch(`/join/dup?username=` + encodeURIComponent(username));

            if (res.ok) {
                messageEl.textContent = "사용 가능한 아이디입니다.";
                messageEl.className = "text-success";
                usernameChecked = true;
            } else {
                messageEl.textContent = "이미 사용 중인 아이디입니다.";
                messageEl.className = "text-danger";
                usernameChecked = false;
            }
        } catch (e) {
            messageEl.textContent = "중복 확인 중 오류가 발생했습니다.";
            messageEl.className = "text-danger";
            usernameChecked = false;
        }

        updateSubmitButtonState();
    }


    // ------------------------------------------------------
    // 약관 전문 보기
    // ------------------------------------------------------
    function showTerms(type) {
        alert(type.toUpperCase() + " 약관 전문을 표시합니다.");
    }

</script>



</body>
</html>
